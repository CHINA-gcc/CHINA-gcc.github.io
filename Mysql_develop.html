<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>MySQL 扩展</title>
    <style type="text/css">
            .top {
                width: 100%;
                height: 20px;
                margin-top: 10px;
                font-size: 20px;
            }
            .top .top-header a{
                width: 100%;
                margin: 5%;
            }
    </style>
  </head>

  <body>
    <div class="container">
        <div class="blog-header">
         <h1  style="color: red;">mysqlserver</h1>
        </div>
        <div class="row">
          <div class="col-sm-8 blog-main">
  
            <div class="blog-post">
    <p> Website built for <a href="www.gcc.中国">GitPages</a> by <a href="www.gcc.中国">@gcc</a>.</p>
    <h3 style="color: blue;">连接器</h3>
<blockquote style="width: 1100px;"><p>基于 tcp 通信协议控制用户的连接.</p></blockquote>
<pre style="width: 1100px;font-size: 1.5em;">show processlist;    查看连接个数.</pre>
<h3 style="color: blue;">分析器</h3>
<blockquote style="width: 1100px;">对 SQL (结构化查询语言)进行词法分析和语法分析, 之后会将 SQL 语句映射为一个组件 AST(抽象语法树).</blockquote>
<h3 style="color: blue;">优化器</h3>
<blockquote style="width: 1100px;">执行 SQL 语句之前, 基于两种优化规则 CBO(成本) / RBO(规则).</blockquote>
<h3 style="color: blue;">执行器</h3>
<blockquote style="width: 1100px;">SQL 语句的实际执行组件.</blockquote>
<h3 style="color: blue;">存储引擎</h3>
<blockquote style="width: 1100px;">不同储存引擎 文件组织形式 | 索引 | 事务 | 锁 不同.</blockquote>
<pre style="width: 1100px;font-size: 1.5em;">show engines;       查看数据库引擎.</pre>
<blockquote style="width: 1100px;">
    <p>MySQL中 .ibd 格式的文件代表 InnoDB 存储引擎.</p>
    <p>MySQL中 .MYD | MYI 格式的文件代表 MyISAM 存储引擎.</p>
    <p>MySQL中 .frm 格式的文件用来储存表结构.</p>
</blockquote>
<h3 style="color: blue;">事务</h3>
<blockquote style="width: 1100px;"><p>扁平式 | 链式 | 嵌套式</p>
<p>数据库事务是构成单一逻辑工作单元的操作集合(SQL), 具有 原子性、一致性、隔离性、持久性(ACID)的特征.</p>
</blockquote>
<h3 style="color: blue;">锁</h3>
<blockquote style="width: 1100px;"><p> 共享锁 | 排查锁 | 独占锁 | 自增锁 | 间隙锁</p></blockquote>
<h3 style="color: blue;">日志(保持原子性和一致性)</h3>
<blockquote style="width: 1100px;">bin-log(二进制日志), 归属于 server 层</blockquote>
<blockquote style="width: 1100px;">bin-log(慢查询日志), 归属于 server 层</blockquote>
<h2 style="color: green;">数据库主从同步配置</h2>
<h3 style="color: blue;">Interpret</h3>
<blockquote style="width: 1100px;"><p>复制数据(异步进行)时, 一个服务器充当主服务器(master), 其余服务器充当从服务器(slave).</p>
<p>从服务器不需要一直连着主服务器, 从服务器可以通过拨号断断续续连接主服务器. 通过配置文件, 可以指定复制所有的数据库、某个数据库、某个表.</p></blockquote>
<h3 style="color: blue;">Advantage</h3>
<blockquote style="width: 1100px;">在主服务器上执行写入和更新, 在从服务器上向外提供读功能. 可动态调整从服务器数量, 从而调整整个数据库的性能.</blockquote>
<blockquote style="width: 1100px;">(提高数据安全)数据复制到从服务器后, 从服务器可以终止复制程序. 可在从服务器复制而不破坏主服务器数据.</blockquote>
<blockquote style="width: 1100px;">主服务器上生成实时数据, 在从服务器上分析这些数据, 从而提高主服务器的性能.</blockquote>
<h3 style="color: blue;">机制</h3>
<blockquote style="width: 1100px;">Mysql 服务器之间的主从同步是基于二进制日志机制. 主服务器使用二进制日志来记录数据库的变动情况, 从服务器通过读取和执行该日志文件来保持和主服务数据一致.</blockquote>
<blockquote style="width: 1100px;">使用二进制日志时, 主服务器的所有操作都会被记录下来, 然后从服务器会接收到该日志的一个副本. 从服务器可以指定执行该日志中的哪一类事件(例如只插入数据或只更新数据).默认会执行日志中的所有语句.</blockquote>
<h3 style="color: blue;">配置基本步骤</h3>
<pre style="width: 1100px;font-size: 1.5em;"><span style="color: red;">①</span>  主服务器必须开启二进制日志机制并配置一个独立的 ID.
<span style="color: red;">②</span>  每一个从服务器上配置一个唯一的 ID, 创建一个用来专门复制主服务器数据的账号.
<span style="color: red;">③</span>  开始复制进程前在主服务器上记录二进制文件的位置信息.
<span style="color: red;">④</span>  开始复制之前若数据库中已有数据, 必须先创建一个数据快照(可使用 mysqldump 导出数据库或直接复制数据文件).
<span style="color: red;">⑤</span>  配置从服务器要连接的主服务器的 IP 地址与登陆授权、二进制日志文件名和位置.</pre>
<h3 style="color: blue;">配置从数据库</h3>
<pre style="width: 1100px;font-size: 1.5em;">docker load -i mysql_docker_5722.tar        拉取镜像.</pre>
<pre style="width: 1100px;font-size: 1.5em;"># <span style="color: red;">mkdir Mysql_slave</span>                         创建新目录.
# Mysql_slave 目录里新建 <span style="color: red;">data 目录</span>.
# <span style="color: red;">cp -r /etc/mysql/mysql.conf.d./</span>           将 Mysql 配置文件拷贝到 Mysql_slave 目录下.
# <span style="color: red;">port</span> = 8306 / <span style="color: red;">general_log</span> = 0(不输出日志) / <span style="color: red;">server-id</span> = 2   从服务器id(唯一).</pre>
<pre style="width: 1100px;font-size: 1.5em;">创建 docker(<span style="color: red;">docker ps</span>) 容器</pre>
<p>docker run <span style="color: red;">--name</span> mysql-slave(目录名) <span style="color: red;">-e</span> <span style="color: red;">MYSQL_ROOT_PASSWORD</span>=(新密码) <span style="color: red;">-d</span>(创建守护式容器在后台运行) <span style="color: red;">--network=host</span>
<span style="color: red;">-v</span> /home/pyvip/mysql_slave/data(从路径)<span style="color: red;">:</span>/var/lib/mysql(主路径) <span style="color: red;">-v</span> /home/pyvip/mysql_slave/mysql.conf.d(从路径)<span style="color: red;">:</span>/etc/mysql/mysql.conf.d(主路径)  mysql:5.7.22</p>
<span style="color: red;">mysql -uroot -p新密码 -h 127.0.0.1 --port=8306</span>(测试)
<h3 style="color: blue;">备份主服务器数据</h3>
			  <pre style="width: 1100px;font-size: 1.5em;">mysqldump -u -p --all-databases --lock-all-tables > ~/master_db.sql
  <span style="color: red;">-u | -p</span>                     主用户 | 主密码.
  <span style="color: red;">--all-databases</span>             导出所有数据库.
  <span style="color: red;">--lock-all-tables</span>           执行操作时锁住所有表, 防止操作时有数据修改.
  <span style="color: red;">~/master_db.sql</span>             导出的备份数据(sql文件)位置, 可自己指定.</pre>
<h3 style="color: blue;">docker容器导入数据</h3>
				  <pre style="width: 1100px;font-size: 1.5em;">mysql -uroot -ppycc -h127.0.0.1 --port=8306 < ~/master_db.sql</pre>
<h3 style="color: blue;">创建从服务器同步数据使用帐号</h3>(主服务器mysql中)
			  <pre style="width: 1100px;font-size: 1.5em;">GRANT REPLICATION SLAVE ON *.* TO '账户'@'%' identified by '密码';
FLUSH PRIVILEGES;</pre>
<h3 style="color: blue;">主服务器二进制日志信息</h3>
			  <pre style="width: 1100px;font-size: 1.5em;">SHOW MASTER STATUS;
<span style="color: red;">File</span>为使用的日志文件名字, <span style="color: red;">Position</span>为使用的文件位置.</pre>
<h3 style="color: blue;">配置从服务器</h3>(从服务器mysql中)
<pre style="width: 1100px;font-size: 1.5em;">change master to master_host='127.0.0.1', master_user='账户', master_password='密码',master_log_file='mysql-bin.000006'(File), master_log_pos=590(Position);</pre>
<h3 style="color: blue;">启动从服务器</h3>
			  <pre style="width: 1100px;font-size: 1.5em;">start slave;
show slave status \G
检查 Slave_IO_Running | Slave_SQL_Running 是否开启.</pre>

        </div><!-- /.blog-main -->

  </div>

      </div><!-- /.row -->

    </div><!-- /.container -->


    <footer class="blog-footer">
        <p style="font-size: 3rem;"><a href="#">Back to top</a></p>
    </footer>

  </body>
</html>